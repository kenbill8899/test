<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èäº¤æ˜“ç¶œåˆè©¦ç®—å™¨ (ç¾è‚¡/æœŸè²¨/èè³‡)</title>
    <style>
        /* åŸºç¤ CSS æ¨£å¼ (èˆ‡ä¸Šä¸€å€‹ç‰ˆæœ¬ç›¸åŒï¼Œç•¥) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 450px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px; 
        }
        
        @media (max-width: 600px) {
            .container {
                margin: 0;
                border-radius: 0;
                padding: 15px;
            }
            body {
                padding-top: 20px;
            }
        }

        h2, h3 {
            text-align: center;
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        .input-group {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            width: calc(100% - 10px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 5px;
        }
        
        .input-shares-container {
            display: flex;
            align-items: center;
        }
        .input-shares-container input {
            flex-grow: 1;
            margin-right: 10px;
        }
        .input-shares-container select {
            width: 80px;
            flex-shrink: 0;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #4cae4c;
        }

        .result-group {
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .section-title {
            background-color: #eee;
            padding: 5px;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            color: #333;
        }

        /* æç›Šé¡¯ç¤ºæ’ç‰ˆ */
        .profit-highlight {
            font-size: 1.1em;
            padding: 8px 0;
            margin-top: 10px;
            border-top: 2px solid #ddd;
            display: grid;
            grid-template-columns: 1fr 1fr;
            font-weight: bold;
            align-items: center;
        }
        .profit-highlight .label-text {
            grid-row: span 2;
            align-self: center;
        }
        .profit-highlight .value {
            text-align: right;
        }
        .profit-highlight .amount {
            font-size: 1.2em;
        }
        .profit-highlight .percent {
            font-size: 0.9em;
            margin-top: -5px;
        }
        /* ç´…æ¼²ç¶ è·Œ (å°ç£æ…£ä¾‹ï¼šç´…è³º/æ¼²ï¼Œç¶ è³ /è·Œ) */
        .profit-red { color: #d9534f; } 
        .profit-green { color: #5cb85c; } 

        /* ç¶­æŒç‡/è­¦ç¤ºæ¨£å¼ */
        .margin-status {
            font-weight: bold;
            padding: 5px;
            margin-top: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .status-ok { background-color: #d4edda; color: #155724; } /* ç¶ è‰²èƒŒæ™¯ï¼šå®‰å…¨ */
        .status-warn { background-color: #fff3cd; color: #856404; } /* é»ƒè‰²èƒŒæ™¯ï¼šè­¦å‘Š */
        .status-danger { background-color: #f8d7da; color: #721c24; } /* ç´…è‰²èƒŒæ™¯ï¼šè¿½ç¹³ */

    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’° é‡‘èäº¤æ˜“ç¶œåˆè©¦ç®—å™¨</h2>
    
    <h3 style="color: #d9534f; border-color: #d9534f;">ğŸ“ˆ å€å¡Šä¸€ï¼šå°è‚¡ç¾è‚¡è²·è³£è©¦ç®—</h3>

    <div class="input-group">
        <label for="stockDiscount">é›»å­ä¸‹å–®æŠ˜æ‰£ (ä¾‹å¦‚: 3æŠ˜è«‹è¼¸å…¥ 0.3):</label>
        <input type="number" id="stockDiscount" value="0.3" min="0" max="1" step="0.01">

        <label for="stockTaxRate">è­‰äº¤ç¨…ç‡ (ä¸€èˆ¬/ç•¶æ²–):</label>
        <select id="stockTaxRate" onchange="calculateStockProfitLoss()">
            <option value="0.003" selected>ä¸€èˆ¬äº¤æ˜“ (0.3%)</option>
            <option value="0.0015">ç¾è‚¡ç•¶æ²– (0.15%)</option>
        </select>
    </div>

    <div class="section-title" style="background-color: #f7e8d9;">è²·å…¥è³‡è¨Š</div>
    <div class="input-group">
        <label for="buyPrice">è²·å…¥åƒ¹ (å…ƒ):</label>
        <input type="number" id="buyPrice" value="64.35" min="0" step="0.01" oninput="calculateStockProfitLoss()">
        
        <label for="buyQuantity">è²·å…¥æ•¸é‡:</label>
        <div class="input-shares-container">
            <input type="number" id="buyQuantity" value="1" min="0" oninput="calculateStockProfitLoss()">
            <select id="buyUnit" onchange="calculateStockProfitLoss()">
                <option value="share">è‚¡</option>
                <option value="lot" selected>å¼µ</option>
            </select>
        </div>
    </div>

    <div class="section-title" style="background-color: #f7e8d9;">è³£å‡ºè³‡è¨Š</div>
    <div class="input-group">
        <label for="sellPrice">è³£å‡ºåƒ¹ (å…ƒ):</label>
        <input type="number" id="sellPrice" value="64.75" min="0" step="0.01" oninput="calculateStockProfitLoss()">
        
        <label for="sellQuantity">è³£å‡ºæ•¸é‡:</label>
        <div class="input-shares-container">
            <input type="number" id="sellQuantity" value="1" min="0" oninput="calculateStockProfitLoss()">
            <select id="sellUnit" onchange="calculateStockProfitLoss()">
                <option value="share">è‚¡</option>
                <option value="lot" selected>å¼µ</option>
            </select>
        </div>
    </div>

    <button onclick="calculateStockProfitLoss()">è¨ˆç®—ç¾è‚¡æç›Š</button>
    
    <div class="result-group">
        <div class="section-title" style="background-color: #d9edf7; color: #31708f;">ç¾è‚¡äº¤æ˜“è²»ç”¨èˆ‡æ·¨æç›Š</div>
        <div class="result-item"><span>è²·å…¥æ‰‹çºŒè²»:</span> <span id="stockBuyFee">--</span></div>
        <div class="result-item"><span>**ç¸½æ”¯å‡º (è²·å…¥æˆæœ¬):**</span> <span id="stockTotalBuyCost">--</span></div>
        <hr>
        <div class="result-item"><span>è³£å‡ºæ‰‹çºŒè²»:</span> <span id="stockSellFee">--</span></div>
        <div class="result-item"><span>è­‰åˆ¸äº¤æ˜“ç¨…:</span> <span id="stockTax">--</span></div>
        <div class="result-item"><span>**ç¸½æ”¶å…¥ (è³£å‡ºæ·¨é¡):**</span> <span id="stockTotalSellIncome">--</span></div>
        
        <div class="profit-highlight">
            <span class="label-text">ğŸ‰ æ·¨ç²åˆ©é‡‘é¡èˆ‡<br>æç›Šç‡(%):</span> 
            <span class="value amount" id="stockNetProfitLossAmount">--</span>
            <span class="value percent" id="stockNetProfitLossPercent">--</span>
        </div>
    </div>


    <h3 style="color: #0d832d; border-color: #0d832d;">ğŸš€ å€å¡ŠäºŒï¼šå°æŒ‡æœŸè²·è³£è©¦ç®—</h3>

    <div class="input-group">
        <label for="futuresType">é¸æ“‡æœŸè²¨åˆç´„:</label>
        <select id="futuresType" onchange="updateFuturesDefaults(); calculateFuturesProfitLoss()">
            <option value="TX">å¤§å° (TX) - 200å…ƒ/é»</option>
            <option value="MTX" selected>å°å° (MTX) - 50å…ƒ/é»</option>
            <option value="MXFF">å¾®å° (MXFF) - 10å…ƒ/é»</option>
        </select>
        <label for="futuresQuantity">äº¤æ˜“å£æ•¸:</label>
        <input type="number" id="futuresQuantity" value="1" min="1" step="1" oninput="calculateFuturesProfitLoss()">
        <label for="futuresFee">å–®é‚Šæ‰‹çºŒè²» (è­°åƒ¹ï¼Œå…ƒ):</label>
        <input type="number" id="futuresFee" value="30" min="1" step="1" oninput="calculateFuturesProfitLoss()">
    </div>

    <div class="section-title" style="background-color: #e6f7d9;">æŒ‡æ•¸é»ä½èˆ‡æç›Š</div>
    <div class="input-group">
        <label for="futuresBuyPoint">è²·å…¥é»ä½:</label>
        <input type="number" id="futuresBuyPoint" value="21800" min="0" step="1" oninput="calculateFuturesProfitLoss()">
        <label for="futuresSellPoint">è³£å‡ºé»ä½:</label>
        <input type="number" id="futuresSellPoint" value="21950" min="0" step="1" oninput="calculateFuturesProfitLoss()">
    </div>

    <button onclick="calculateFuturesProfitLoss()">è¨ˆç®—æœŸè²¨æç›Š</button>
    
    <div class="result-group">
        <div class="section-title" style="background-color: #d9edf7; color: #31708f;">æœŸè²¨è²»ç”¨èˆ‡æ·¨æç›Š</div>
        <div class="result-item"><span>æ¯é»åƒ¹å€¼ (å¥‘ç´„ä¹˜æ•¸):</span> <span id="futuresMultiplier">--</span></div>
        <div class="result-item"><span>**åŸå§‹ä¿è­‰é‡‘ (IM):**</span> <span id="futuresInitialMargin">--</span></div>
        <div class="result-item"><span>**ç¶­æŒä¿è­‰é‡‘ (MM):**</span> <span id="futuresMaintenanceMargin">--</span></div>
        <hr>
        <div class="result-item"><span>äº¤æ˜“é»æ•¸åƒ¹å·®:</span> <span id="futuresPointDifference">--</span></div>
        <div class="result-item"><span>ç¸½æ‰‹çºŒè²» + äº¤æ˜“ç¨…:</span> <span id="futuresTotalCost">--</span></div>

        <div class="profit-highlight">
            <span class="label-text">ğŸ‰ æ·¨ç²åˆ©é‡‘é¡:</span> 
            <span class="value amount" id="futuresNetProfitLossAmount">--</span>
            <span class="value percent" id="futuresNetProfitLossPercent">--</span>
        </div>

        <div id="futuresMarginStatus" class="margin-status">--</div>
    </div>


    <h3 style="color: #6a1b9a; border-color: #6a1b9a;">ğŸ¦ å€å¡Šä¸‰ï¼šè‚¡ç¥¨èè³‡è²·è³£è©¦ç®—</h3>

    <div class="input-group">
        <label for="marginType">è‚¡ç¥¨é¡åˆ¥ (æ±ºå®šèè³‡æˆæ•¸):</label>
        <select id="marginType" onchange="calculateMarginProfitLoss()">
            <option value="listed" selected>ä¸Šå¸‚è‚¡ç¥¨ (èè³‡æˆæ•¸ 60%)</option>
            <option value="otc">ä¸Šæ«ƒè‚¡ç¥¨ (èè³‡æˆæ•¸ 50%)</option>
        </select>
        <label for="marginRate">èè³‡å¹´åˆ©ç‡ (å¹´åŒ– %):</label>
        <input type="number" id="marginRate" value="6.5" min="0" step="0.1" oninput="calculateMarginProfitLoss()">
        <label for="marginDays">æŒæœ‰å¤©æ•¸ (è¨ˆæ¯å¤©æ•¸):</label>
        <input type="number" id="marginDays" value="30" min="1" step="1" oninput="calculateMarginProfitLoss()">
    </div>

    <div class="section-title" style="background-color: #e6d9f7;">äº¤æ˜“è³‡è¨Š (èˆ‡ç¾è‚¡åˆ†é–‹è¼¸å…¥)</div>
    <div class="input-group">
        <label for="marginBuyPrice">è²·å…¥åƒ¹ (å…ƒ):</label>
        <input type="number" id="marginBuyPrice" value="60" min="0" step="0.01" oninput="calculateMarginProfitLoss()">
        <label for="marginSellPrice">è³£å‡ºåƒ¹ (å…ƒï¼Œ**å¡«å¯«ç¾è¡Œè‚¡åƒ¹**):</label>
        <input type="number" id="marginSellPrice" value="63" min="0" step="0.01" oninput="calculateMarginProfitLoss()">
        <label for="marginQuantity">äº¤æ˜“å¼µæ•¸:</label>
        <input type="number" id="marginQuantity" value="1" min="1" step="1" oninput="calculateMarginProfitLoss()">
        <label for="marginDiscount">æ‰‹çºŒè²»æŠ˜æ‰£ (ä¾‹å¦‚: 6æŠ˜ 0.6):</label>
        <input type="number" id="marginDiscount" value="0.6" min="0" max="1" step="0.01" oninput="calculateMarginProfitLoss()">
    </div>

    <button onclick="calculateMarginProfitLoss()">è¨ˆç®—èè³‡æç›Šèˆ‡ç¶­æŒç‡</button>
    
    <div class="result-group">
        <div class="section-title" style="background-color: #d9edf7; color: #31708f;">èè³‡æˆæœ¬èˆ‡æç›Š</div>
        <div class="result-item"><span>èè³‡é‡‘é¡ (åˆ¸å•†å€Ÿæ¬¾):</span> <span id="marginLoanAmount">--</span></div>
        <div class="result-item"><span>**ç¸½åˆ©æ¯æ”¯å‡º (æŒæœ‰å¤©æ•¸):**</span> <span id="marginTotalInterest">--</span></div>
        <div class="result-item"><span>**æ·¨æç›Š (å«æ‰€æœ‰æˆæœ¬):**</span> <span id="marginNetProfitLossAmount">--</span></div>
        
        <div class="profit-highlight">
            <span class="label-text">ğŸ‰ æ·¨æç›Šç‡<br>(ç›¸å°æ–¼è‡ªå‚™æ¬¾%):</span> 
            <span class="value amount" id="marginNetProfitLossRate">--</span>
            <span class="value percent" id="marginNetProfitLossPercent">--</span>
        </div>
        
        <hr>
        <div class="section-title" style="background-color: #f7e8d9;">èè³‡ç¶­æŒç‡</div>
        <div class="result-item"><span>**ç›®å‰ç¶­æŒç‡:**</span> <span id="marginCurrentRate">--</span></div>
        <div id="marginStatus" class="margin-status">--</div>
    </div>
</div>

<script>
    // æ•¸å­—æ ¼å¼åŒ–å·¥å…·
    const amountFormatter = new Intl.NumberFormat('zh-TW', { 
        minimumFractionDigits: 0, 
        maximumFractionDigits: 2,
        useGrouping: true
    });
    const percentFormatter = new Intl.NumberFormat('zh-TW', { 
        minimumFractionDigits: 1, 
        maximumFractionDigits: 2
    });

    // ==============================================
    // å‡½æ•¸ 1: ç¾è‚¡è²·è³£è©¦ç®— (çœç•¥)
    // ==============================================
    function calculateStockProfitLoss() {
        // ... (èˆ‡ä¸Šä¸€å€‹ç‰ˆæœ¬ç›¸åŒï¼Œç‚ºç¯€çœç©ºé–“ç•¥)
        const discount = parseFloat(document.getElementById('stockDiscount').value) || 1;
        const taxRate = parseFloat(document.getElementById('stockTaxRate').value) || 0.003;
        const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
        const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
        const buyQuantityInput = parseFloat(document.getElementById('buyQuantity').value) || 0;
        const buyUnit = document.getElementById('buyUnit').value;
        const sellQuantityInput = parseFloat(document.getElementById('sellQuantity').value) || 0;
        const sellUnit = document.getElementById('sellUnit').value;

        const buyShares = buyUnit === 'lot' ? buyQuantityInput * 1000 : buyQuantityInput;
        const sellShares = sellUnit === 'lot' ? sellQuantityInput * 1000 : sellQuantityInput;
        
        const commissionRate = 0.001425;
        const minFee = 1;

        const buyAmount = buyPrice * buyShares;
        let calculatedBuyFee = Math.ceil(buyAmount * commissionRate * discount); 
        const buyFee = Math.max(calculatedBuyFee, minFee);
        const totalBuyCost = buyAmount + buyFee;

        const sellAmount = sellPrice * sellShares;
        let calculatedSellFee = Math.ceil(sellAmount * commissionRate * discount);
        const sellFee = Math.max(calculatedSellFee, minFee);
        const tax = Math.round(sellAmount * taxRate); 
        const totalSellIncome = sellAmount - sellFee - tax;

        const netProfitLoss = totalSellIncome - totalBuyCost;
        const profitPercentage = totalBuyCost > 0 ? (netProfitLoss / totalBuyCost) * 100 : 0;

        document.getElementById('stockBuyFee').textContent = amountFormatter.format(buyFee);
        document.getElementById('stockTotalBuyCost').textContent = amountFormatter.format(totalBuyCost);
        document.getElementById('stockSellFee').textContent = amountFormatter.format(sellFee);
        document.getElementById('stockTax').textContent = amountFormatter.format(tax);
        document.getElementById('stockTotalSellIncome').textContent = amountFormatter.format(totalSellIncome);

        const amountElement = document.getElementById('stockNetProfitLossAmount');
        const percentElement = document.getElementById('stockNetProfitLossPercent');
        
        amountElement.textContent = amountFormatter.format(netProfitLoss);
        percentElement.textContent = `(${percentFormatter.format(profitPercentage)}%)`;
        
        const colorClass = netProfitLoss > 0 ? 'profit-red' : (netProfitLoss < 0 ? 'profit-green' : '');
        amountElement.classList.remove('profit-red', 'profit-green');
        percentElement.classList.remove('profit-red', 'profit-green');
        if (colorClass) {
            amountElement.classList.add(colorClass);
            percentElement.classList.add(colorClass);
        } else {
             amountElement.style.color = 'black'; 
             percentElement.style.color = 'black'; 
        }
    }


    // ==============================================
    // å‡½æ•¸ 2: å°æŒ‡æœŸè²·è³£è©¦ç®— (æ–°å¢ç¶­æŒä¿è­‰é‡‘å’Œè¿½ç¹³æç¤º)
    // ==============================================

    // æœŸè²¨åˆç´„å¸¸æ•¸ (ä»¥æœŸäº¤æ‰€æœ€æ–°å…¬å‘Šç‚ºæº–ï¼Œé€™è£¡ä½¿ç”¨åƒè€ƒå€¼)
    const FUTURES_CONTRACTS = {
        'TX': { multiplier: 200, IM: 184000, MM: 142000, taxRate: 0.00002 }, // å¤§å° (IM: åˆå§‹ä¿è­‰é‡‘, MM: ç¶­æŒä¿è­‰é‡‘)
        'MTX': { multiplier: 50, IM: 46000, MM: 35500, taxRate: 0.00002 },  // å°å°
        'MXFF': { multiplier: 10, IM: 9200, MM: 7100, taxRate: 0.00002 }   // å¾®å°
    };
    
    function updateFuturesDefaults() {
        const type = document.getElementById('futuresType').value;
        const contract = FUTURES_CONTRACTS[type];
        
        // é¡¯ç¤ºåˆç´„ä¹˜æ•¸å’Œé ä¼°ä¿è­‰é‡‘
        document.getElementById('futuresMultiplier').textContent = amountFormatter.format(contract.multiplier) + ' å…ƒ/é»';
        document.getElementById('futuresInitialMargin').textContent = amountFormatter.format(contract.IM) + ' å…ƒ';
        document.getElementById('futuresMaintenanceMargin').textContent = amountFormatter.format(contract.MM) + ' å…ƒ'; // æ–°å¢ ç¶­æŒä¿è­‰é‡‘
    }

    function calculateFuturesProfitLoss() {
        const type = document.getElementById('futuresType').value;
        const quantity = parseFloat(document.getElementById('futuresQuantity').value) || 0;
        const fee = parseFloat(document.getElementById('futuresFee').value) || 0;
        const buyPoint = parseFloat(document.getElementById('futuresBuyPoint').value) || 0;
        const sellPoint = parseFloat(document.getElementById('futuresSellPoint').value) || 0;

        if (quantity <= 0) return;

        const contract = FUTURES_CONTRACTS[type];
        const multiplier = contract.multiplier;
        const taxRate = contract.taxRate;
        
        // 1. æç›Šè¨ˆç®—
        const pointDifference = sellPoint - buyPoint;
        const grossProfitLoss = pointDifference * multiplier * quantity;

        // 2. äº¤æ˜“æˆæœ¬ (è²·è³£é›™é‚Šç¨…å’Œæ‰‹çºŒè²»)
        const buyAmount = buyPoint * multiplier * quantity;
        const sellAmount = sellPoint * multiplier * quantity;
        const totalTax = Math.round(buyAmount * taxRate) + Math.round(sellAmount * taxRate);
        const totalFee = fee * 2 * quantity;
        const totalCost = totalFee + totalTax;

        // 3. æ·¨æç›Š
        const netProfitLoss = grossProfitLoss - totalCost;

        // 4. ç¶­æŒç‡/è¿½ç¹³è¨ˆç®—
        const IMTotal = contract.IM * quantity; // åˆå§‹æŠ•å…¥çš„ç¸½ä¿è­‰é‡‘
        // æœŸè²¨å¸³æˆ¶é¤˜é¡ = åˆå§‹ä¿è­‰é‡‘ + æ·¨æç›Š (å‡è¨­æ·¨æç›Šå°šæœªå¯¦ç¾ï¼Œä½†å·²åæ˜ åœ¨æ¬Šç›Šæ•¸ä¸Š)
        const accountEquity = IMTotal + grossProfitLoss; 
        const MMTotal = contract.MM * quantity; // ç¸½ç¶­æŒä¿è­‰é‡‘
        
        // 5. é¡¯ç¤ºçµæœ
        document.getElementById('futuresPointDifference').textContent = amountFormatter.format(pointDifference) + ' é»';
        document.getElementById('futuresTotalCost').textContent = amountFormatter.format(totalCost);
        
        const amountElement = document.getElementById('futuresNetProfitLossAmount');
        const statusElement = document.getElementById('futuresMarginStatus');
        
        amountElement.textContent = amountFormatter.format(netProfitLoss);
        
        // æœŸè²¨ç¶­æŒç‡æç¤º
        statusElement.classList.remove('status-ok', 'status-warn', 'status-danger');

        if (accountEquity < MMTotal) {
            const shortfall = MMTotal - accountEquity;
            statusElement.textContent = `âŒ é¢¨éšªè­¦å‘Š: æ¬Šç›Šæ•¸ ${amountFormatter.format(accountEquity)} å…ƒï¼Œä½æ–¼ç¶­æŒä¿è­‰é‡‘ï¼éœ€è¿½ç¹³ ${amountFormatter.format(shortfall)} å…ƒã€‚`;
            statusElement.classList.add('status-danger');
        } else if (accountEquity < IMTotal * 1.2) { // è¨­ä¸€å€‹è­¦ç¤ºç·šï¼Œä¾‹å¦‚è¶…éç¶­æŒä¿è­‰é‡‘ä¸€é»é»
            statusElement.textContent = `âš ï¸ é¤˜é¡æ¥è¿‘ç¶­æŒä¿è­‰é‡‘ï¼Œè«‹ç•™æ„é¢¨éšªã€‚`;
            statusElement.classList.add('status-warn');
        } else {
            statusElement.textContent = `âœ… æ¬Šç›Šæ•¸ ${amountFormatter.format(accountEquity)} å…ƒï¼Œä¿è­‰é‡‘å……è¶³ã€‚`;
            statusElement.classList.add('status-ok');
        }

        // æ ¹æ“šæç›Šèª¿æ•´é¡è‰²
        const colorClass = netProfitLoss > 0 ? 'profit-red' : (netProfitLoss < 0 ? 'profit-green' : '');
        amountElement.classList.remove('profit-red', 'profit-green');
        if (colorClass) {
            amountElement.classList.add(colorClass);
        } else {
             amountElement.style.color = 'black'; 
        }
    }


    // ==============================================
    // å‡½æ•¸ 3: è‚¡ç¥¨èè³‡è²·è³£è©¦ç®— (æ–°å¢èè³‡ç¶­æŒç‡)
    // ==============================================
    function calculateMarginProfitLoss() {
        const type = document.getElementById('marginType').value;
        const rateInput = parseFloat(document.getElementById('marginRate').value) || 0;
        const days = parseFloat(document.getElementById('marginDays').value) || 0;
        const buyPrice = parseFloat(document.getElementById('marginBuyPrice').value) || 0;
        const currentPrice = parseFloat(document.getElementById('marginSellPrice').value) || 0; // è³£å‡ºåƒ¹ä½œç‚ºç¾è¡Œè‚¡åƒ¹
        const quantity = parseFloat(document.getElementById('marginQuantity').value) || 0;
        const discount = parseFloat(document.getElementById('marginDiscount').value) || 1;

        if (quantity <= 0) return;

        // 1. å®šç¾©å¸¸æ•¸
        const commissionRate = 0.001425; 
        const taxRate = 0.003;          
        const minFee = 20;              
        const sharesPerLot = 1000;
        const annualDays = 365;
        const financingRate = rateInput / 100; 

        // èè³‡æˆæ•¸ (ä¸Šå¸‚ 60%, ä¸Šæ«ƒ 50%)
        const loanRatio = type === 'listed' ? 0.6 : 0.5;
        const selfCoverageRatio = 1 - loanRatio;
        
        // 2. è³‡é‡‘è¨ˆç®—
        const buyAmount = buyPrice * sharesPerLot * quantity;
        const currentAmount = currentPrice * sharesPerLot * quantity; // è‚¡ç¥¨ç¾å€¼

        const loanAmount = buyAmount * loanRatio; // èè³‡å€Ÿæ¬¾é‡‘é¡

        // 3. èè³‡ç¶­æŒç‡è¨ˆç®—
        // ç¶­æŒç‡ = (è‚¡ç¥¨ç¾å€¼ / èè³‡é‡‘é¡) * 100%
        const maintenanceRate = (currentAmount / loanAmount) * 100;

        // 4. äº¤æ˜“æˆæœ¬ (å‡è¨­ç¾åƒ¹å°±æ˜¯å¹³å€‰è³£å‡ºåƒ¹ä¾†è¨ˆç®—æˆæœ¬å’Œæç›Š)
        
        // a. åˆ©æ¯ (ä»¥èè³‡é‡‘é¡è¨ˆæ¯)
        const totalInterest = loanAmount * financingRate * (days / annualDays);

        // b. äº¤æ˜“è²»ç”¨ (è²·å…¥ä»¥è²·åƒ¹è¨ˆç®—ï¼Œè³£å‡ºä»¥ç¾åƒ¹/è³£åƒ¹è¨ˆç®—)
        const calculatedBuyFee = buyAmount * commissionRate * discount;
        const buyFee = Math.max(calculatedBuyFee, minFee);
        
        const calculatedSellFee = currentAmount * commissionRate * discount;
        const sellFee = Math.max(calculatedSellFee, minFee);
        const tax = Math.round(currentAmount * taxRate); 
        
        const totalCost = buyFee + sellFee + tax + totalInterest;

        // 5. æç›Šè¨ˆç®—
        const grossProfitLoss = currentAmount - buyAmount; // åƒ¹å·®æç›Š
        const netProfitLoss = grossProfitLoss - totalCost; // æ·¨æç›Š = åƒ¹å·® - ç¸½æˆæœ¬
        
        // èè³‡æ·¨æç›Šç‡ (ç›¸å°æ–¼è‡ªå‚™æ¬¾)
        const selfCoverageAmount = buyAmount * selfCoverageRatio;
        const actualSelfCoverage = selfCoverageAmount + buyFee; // å¯¦éš›æŠ•å…¥çš„è³‡é‡‘ (è‡ªå‚™æ¬¾ + è²·å…¥æ‰‹çºŒè²»)
        const profitPercentage = actualSelfCoverage > 0 ? (netProfitLoss / actualSelfCoverage) * 100 : 0;
        
        // 6. é¡¯ç¤ºçµæœ
        document.getElementById('marginLoanAmount').textContent = amountFormatter.format(loanAmount);
        document.getElementById('marginTotalInterest').textContent = amountFormatter.format(totalInterest);
        document.getElementById('marginNetProfitLossAmount').textContent = amountFormatter.format(netProfitLoss);
        
        document.getElementById('marginCurrentRate').textContent = percentFormatter.format(maintenanceRate) + '%';
        
        const amountElement = document.getElementById('marginNetProfitLossRate');
        const percentElement = document.getElementById('marginNetProfitLossPercent');
        const statusElement = document.getElementById('marginStatus');

        amountElement.textContent = amountFormatter.format(netProfitLoss); // æ·¨æç›Šé‡‘é¡
        percentElement.textContent = `(${percentFormatter.format(profitPercentage)}%)`; // æ·¨æç›Šç‡

        // èè³‡ç¶­æŒç‡æç¤º
        statusElement.classList.remove('status-ok', 'status-warn', 'status-danger');
        let statusText = '';
        
        if (maintenanceRate < 130) {
            statusText = `ğŸš¨ **ä½æ–¼ 130% è¿½ç¹³ç·šï¼** éœ€åœ¨æœŸé™å…§è£œç¹³ä¿è­‰é‡‘ã€‚`;
            statusElement.classList.add('status-danger');
        } else if (maintenanceRate < 166) {
            statusText = `âš ï¸ è¿½ç¹³ä¸­ï¼Œç¶­æŒç‡ä»‹æ–¼ 130% - 166%ï¼Œéœ€è£œç¹³æ‰èƒ½è§£é™¤è¿½ç¹³ã€‚`;
            statusElement.classList.add('status-warn');
        } else {
            statusText = `âœ… **å®‰å…¨å€** (ç¶­æŒç‡ ${percentFormatter.format(maintenanceRate)}%)ã€‚`;
            statusElement.classList.add('status-ok');
        }
        statusElement.innerHTML = statusText;

        // æ ¹æ“šæ·¨æç›Šèª¿æ•´é¡è‰²
        const colorClass = netProfitLoss > 0 ? 'profit-red' : (netProfitLoss < 0 ? 'profit-green' : '');
        amountElement.classList.remove('profit-red', 'profit-green');
        percentElement.classList.remove('profit-red', 'profit-green');
        if (colorClass) {
            amountElement.classList.add(colorClass);
            percentElement.classList.add(colorClass);
        } else {
             amountElement.style.color = 'black'; 
             percentElement.style.color = 'black'; 
        }
    }

    // é é¢è¼‰å…¥å¾Œï¼Œè‡ªå‹•åŸ·è¡Œæ‰€æœ‰è¨ˆç®—
    document.addEventListener('DOMContentLoaded', () => {
        calculateStockProfitLoss();

        // æœŸè²¨
        updateFuturesDefaults();
        calculateFuturesProfitLoss();
        document.querySelectorAll('#futuresType, #futuresQuantity, #futuresFee, #futuresBuyPoint, #futuresSellPoint').forEach(element => {
            element.addEventListener('input', calculateFuturesProfitLoss);
        });

        // èè³‡
        calculateMarginProfitLoss();
        document.querySelectorAll('#marginType, #marginRate, #marginDays, #marginBuyPrice, #marginSellPrice, #marginQuantity, #marginDiscount').forEach(element => {
            element.addEventListener('input', calculateMarginProfitLoss);
        });
    });
</script>

</body>
</html>
